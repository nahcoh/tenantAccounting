name: Deploy

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'docker-compose.prod.yml'
      - '.github/workflows/**'

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: ap-northeast-2

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - '.github/workflows/**'
            backend:
              - 'backend/**'
              - 'docker-compose.prod.yml'
              - '.github/workflows/**'

  deploy-frontend:
    needs: changes
    if: needs.changes.outputs.frontend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run lint
          npm run build
        env:
          VITE_API_BASE_URL: ${{ github.ref == 'refs/heads/main' && secrets.PROD_API_URL || secrets.DEV_API_URL }}

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Select deployment target
        id: env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "S3_BUCKET=${{ secrets.PROD_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
            echo "CLOUDFRONT_ID=${{ secrets.PROD_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
            echo "ENVIRONMENT=production" >> "$GITHUB_OUTPUT"
          else
            echo "S3_BUCKET=${{ secrets.DEV_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
            echo "CLOUDFRONT_ID=${{ secrets.DEV_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
            echo "ENVIRONMENT=development" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy to S3
        run: |
          aws s3 sync frontend/dist/ s3://${{ steps.env.outputs.S3_BUCKET }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"

          aws s3 cp frontend/dist/index.html s3://${{ steps.env.outputs.S3_BUCKET }}/index.html \
            --cache-control "no-cache, no-store, must-revalidate"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.env.outputs.CLOUDFRONT_ID }} \
            --paths "/*"

  deploy-backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Select deployment target
        id: env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "EC2_HOST=${{ secrets.PROD_EC2_HOST }}" >> "$GITHUB_OUTPUT"
            echo "EC2_USER=${{ secrets.PROD_EC2_USER }}" >> "$GITHUB_OUTPUT"
          else
            echo "EC2_HOST=${{ secrets.DEV_EC2_HOST }}" >> "$GITHUB_OUTPUT"
            echo "EC2_USER=${{ secrets.DEV_EC2_USER }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Create target directory via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.env.outputs.EC2_HOST }}
          username: ${{ steps.env.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: mkdir -p /home/${{ steps.env.outputs.EC2_USER }}/ziplog

      - name: Copy source code to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.env.outputs.EC2_HOST }}
          username: ${{ steps.env.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend/**,docker-compose.prod.yml"
          target: "/home/${{ steps.env.outputs.EC2_USER }}/ziplog"
          strip_components: 0

      - name: Deploy backend on EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
        with:
          host: ${{ steps.env.outputs.EC2_HOST }}
          username: ${{ steps.env.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: MYSQL_ROOT_PASSWORD,MYSQL_DATABASE,JWT_SECRET,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,KAKAO_CLIENT_ID,KAKAO_CLIENT_SECRET,CORS_ALLOWED_ORIGINS
          script: |
            cd /home/${{ steps.env.outputs.EC2_USER }}/ziplog

            echo "MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD" > .env
            echo "MYSQL_DATABASE=$MYSQL_DATABASE" >> .env
            echo "JWT_SECRET=$JWT_SECRET" >> .env
            echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> .env
            echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> .env
            echo "KAKAO_CLIENT_ID=$KAKAO_CLIENT_ID" >> .env
            echo "KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET" >> .env
            echo "CORS_ALLOWED_ORIGINS=$CORS_ALLOWED_ORIGINS" >> .env

            docker-compose -f docker-compose.prod.yml up -d --build
            docker image prune -f
