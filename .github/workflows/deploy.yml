name: Deploy

on:
  push:
    branches: [main, develop]
    paths:
      - 'frontend/**'
      - 'backend/**'
      - 'docker-compose.prod.yml'
      - '.github/workflows/**'

permissions:
  contents: read

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  AWS_REGION: ap-northeast-2

jobs:
  changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.filter.outputs.frontend }}
      backend: ${{ steps.filter.outputs.backend }}
    steps:
      - uses: actions/checkout@v4
      - id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'frontend/**'
              - '.github/workflows/**'
            backend:
              - 'backend/**'
              - 'docker-compose.prod.yml'
              - '.github/workflows/**'

  deploy-backend:
    needs: changes
    if: needs.changes.outputs.backend == 'true'
    runs-on: ubuntu-latest
    environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
    steps:
      - uses: actions/checkout@v4

      - name: Select deployment target
        id: env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "EC2_HOST=${{ secrets.PROD_EC2_HOST }}" >> "$GITHUB_OUTPUT"
            echo "EC2_USER=${{ secrets.PROD_EC2_USER }}" >> "$GITHUB_OUTPUT"
            echo "ENVIRONMENT=production" >> "$GITHUB_OUTPUT"
          else
            echo "EC2_HOST=${{ secrets.DEV_EC2_HOST }}" >> "$GITHUB_OUTPUT"
            echo "EC2_USER=${{ secrets.DEV_EC2_USER }}" >> "$GITHUB_OUTPUT"
            echo "ENVIRONMENT=development" >> "$GITHUB_OUTPUT"
          fi

      - name: Create target directory via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ steps.env.outputs.EC2_HOST }}
          username: ${{ steps.env.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: mkdir -p /home/${{ steps.env.outputs.EC2_USER }}/ziplog

      - name: Copy source code to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ steps.env.outputs.EC2_HOST }}
          username: ${{ steps.env.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "backend/**,docker-compose.prod.yml"
          target: "/home/${{ steps.env.outputs.EC2_USER }}/ziplog"
          strip_components: 0

      - name: Deploy backend and verify runtime on EC2
        uses: appleboy/ssh-action@v1.0.3
        env:
          MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          KAKAO_CLIENT_ID: ${{ secrets.KAKAO_CLIENT_ID }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
          AUTH_COOKIE_DOMAIN: ${{ secrets.AUTH_COOKIE_DOMAIN }}
          GITHUB_SHA: ${{ github.sha }}
        with:
          host: ${{ steps.env.outputs.EC2_HOST }}
          username: ${{ steps.env.outputs.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          envs: MYSQL_ROOT_PASSWORD,MYSQL_DATABASE,JWT_SECRET,GOOGLE_CLIENT_ID,GOOGLE_CLIENT_SECRET,KAKAO_CLIENT_ID,KAKAO_CLIENT_SECRET,CORS_ALLOWED_ORIGINS,AUTH_COOKIE_DOMAIN,GITHUB_SHA
          script: |
            set -euo pipefail

            cd /home/${{ steps.env.outputs.EC2_USER }}/ziplog

            : "${MYSQL_ROOT_PASSWORD:?MYSQL_ROOT_PASSWORD is required}"
            : "${MYSQL_DATABASE:?MYSQL_DATABASE is required}"
            : "${JWT_SECRET:?JWT_SECRET is required}"
            : "${GOOGLE_CLIENT_ID:?GOOGLE_CLIENT_ID is required}"
            : "${GOOGLE_CLIENT_SECRET:?GOOGLE_CLIENT_SECRET is required}"
            : "${KAKAO_CLIENT_ID:?KAKAO_CLIENT_ID is required}"
            : "${KAKAO_CLIENT_SECRET:?KAKAO_CLIENT_SECRET is required}"
            : "${CORS_ALLOWED_ORIGINS:?CORS_ALLOWED_ORIGINS is required}"
            : "${AUTH_COOKIE_DOMAIN:?AUTH_COOKIE_DOMAIN is required}"

            echo "MYSQL_ROOT_PASSWORD=$MYSQL_ROOT_PASSWORD" > .env
            echo "MYSQL_DATABASE=$MYSQL_DATABASE" >> .env
            echo "JWT_SECRET=$JWT_SECRET" >> .env
            echo "GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID" >> .env
            echo "GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET" >> .env
            echo "KAKAO_CLIENT_ID=$KAKAO_CLIENT_ID" >> .env
            echo "KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET" >> .env
            echo "CORS_ALLOWED_ORIGINS=$CORS_ALLOWED_ORIGINS" >> .env
            echo "AUTH_COOKIE_DOMAIN=$AUTH_COOKIE_DOMAIN" >> .env
            echo "SPRING_JPA_HIBERNATE_DDL_AUTO=update" >> .env
            echo "APP_COMMIT_SHA=$GITHUB_SHA" >> .env

            mkdir -p backups
            if docker ps --format '{{.Names}}' | grep -q '^ziplog-mysql$'; then
              ts=$(date +%Y%m%d_%H%M%S)
              docker exec ziplog-mysql sh -lc "mysqldump -uroot -p\"$MYSQL_ROOT_PASSWORD\" \"$MYSQL_DATABASE\"" > "backups/mysql_${ts}.sql"
              find backups -type f -name 'mysql_*.sql' -mtime +7 -delete || true
              echo "Database backup created: backups/mysql_${ts}.sql"
            else
              echo "ziplog-mysql not running, skip backup step"
            fi

            docker compose -f docker-compose.prod.yml down --remove-orphans || true
            docker compose -f docker-compose.prod.yml up -d --build --force-recreate --remove-orphans

            backend_container_id=$(docker compose -f docker-compose.prod.yml ps -q backend | head -n1)
            if [ -z "$backend_container_id" ]; then
              echo "Backend container id not found"
              docker compose -f docker-compose.prod.yml ps || true
              docker compose -f docker-compose.prod.yml logs backend --tail=200 || true
              exit 1
            fi

            for i in $(seq 1 40); do
              status=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}{{.State.Status}}{{end}}' "$backend_container_id" 2>/dev/null || echo missing)
              [ -z "$status" ] && status=missing
              echo "backend status: $status (attempt $i/40)"

              if [ "$status" = "healthy" ] || [ "$status" = "running" ]; then
                break
              fi

              if [ "$status" = "unhealthy" ] || [ "$status" = "missing" ]; then
                echo "Backend container is not healthy"
                docker compose -f docker-compose.prod.yml logs backend --tail=200 || true
                exit 1
              fi

              sleep 5
            done

            final_status=$(docker inspect --format='{{if .State.Health}}{{.State.Health.Status}}{{else}}{{.State.Status}}{{end}}' "$backend_container_id" 2>/dev/null || echo missing)
            [ -z "$final_status" ] && final_status=missing
            if [ "$final_status" != "healthy" ] && [ "$final_status" != "running" ]; then
              echo "Backend did not become healthy in time"
              docker compose -f docker-compose.prod.yml logs backend --tail=200 || true
              exit 1
            fi

            if docker exec "$backend_container_id" sh -lc "strings /app/app.jar | grep -q 'queryParam(\"accessToken\")'"; then
              echo "Old OAuth query-token runtime signature detected"
              exit 1
            fi

            code=$(curl -s -o /dev/null -w '%{http_code}' http://localhost:8080/api/auth/me || true)
            if [ "$code" != "401" ] && [ "$code" != "200" ]; then
              echo "Unexpected /api/auth/me status: $code"
              exit 1
            fi

            docker ps --format "table {{.Names}}\t{{.Status}}\t{{.RunningFor}}"

      - name: Backend deployment summary
        run: |
          echo "## Backend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ steps.env.outputs.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- EC2 Host: ${{ steps.env.outputs.EC2_HOST }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  deploy-frontend:
    needs: [changes, deploy-backend]
    if: needs.changes.outputs.frontend == 'true' && (needs.changes.outputs.backend != 'true' || needs.deploy-backend.result == 'success')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: npm
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        working-directory: frontend
        run: |
          npm ci
          npm run lint
          npm run build
        env:
          VITE_API_BASE_URL: ${{ github.ref == 'refs/heads/main' && secrets.PROD_API_URL || secrets.DEV_API_URL }}

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Select deployment target
        id: env
        run: |
          if [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "S3_BUCKET=${{ secrets.PROD_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
            echo "CLOUDFRONT_ID=${{ secrets.PROD_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
            echo "ENVIRONMENT=production" >> "$GITHUB_OUTPUT"
          else
            echo "S3_BUCKET=${{ secrets.DEV_S3_BUCKET }}" >> "$GITHUB_OUTPUT"
            echo "CLOUDFRONT_ID=${{ secrets.DEV_CLOUDFRONT_ID }}" >> "$GITHUB_OUTPUT"
            echo "ENVIRONMENT=development" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy to S3
        run: |
          aws s3 sync frontend/dist/ s3://${{ steps.env.outputs.S3_BUCKET }} \
            --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "index.html" \
            --exclude "*.json"

          aws s3 cp frontend/dist/index.html s3://${{ steps.env.outputs.S3_BUCKET }}/index.html \
            --cache-control "no-cache, no-store, must-revalidate"

      - name: Invalidate CloudFront cache
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ steps.env.outputs.CLOUDFRONT_ID }} \
            --paths "/*"

      - name: Frontend deployment summary
        run: |
          echo "## Frontend Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: ${{ steps.env.outputs.ENVIRONMENT }}" >> $GITHUB_STEP_SUMMARY
          echo "- S3 Bucket: ${{ steps.env.outputs.S3_BUCKET }}" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
